<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js';
  import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDDB8wgUqtfZUHx0qc6xT97L7oBp-k9nns",
    authDomain: "viral-cok.firebaseapp.com",
    projectId: "viral-cok",
    storageBucket: "viral-cok.firebasestorage.app",
    messagingSenderId: "465866226747",
    appId: "1:465866226747:web:cbe62190014be0f1bcf01e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Load saved videos and download link
  window.onload = async () => {
    try {
      // Load videos
      const videosDoc = await getDoc(doc(db, 'settings', 'youtubeVideos'));
      const videos = videosDoc.exists() ? videosDoc.data().urls : ['', '', '', '', ''];
      document.getElementById('video1').value = videos[0] || '';
      document.getElementById('video2').value = videos[1] || '';
      document.getElementById('video3').value = videos[2] || '';
      document.getElementById('video4').value = videos[3] || '';
      document.getElementById('video5').value = videos[4] || '';

      // Load download link
      const downloadDoc = await getDoc(doc(db, 'settings', 'downloadLink'));
      const downloadLink = downloadDoc.exists() ? downloadDoc.data().url : '';
      document.getElementById('downloadLink').value = downloadLink;
    } catch (error) {
      console.error('Error loading settings:', error);
      alert('Failed to load settings. Check console for details.');
    }
  };

  async function saveVideos() {
    const videos = [
      document.getElementById('video1').value.trim(),
      document.getElementById('video2').value.trim(),
      document.getElementById('video3').value.trim(),
      document.getElementById('video4').value.trim(),
      document.getElementById('video5').value.trim()
    ];

    // Validate URLs
    const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/(watch\?v=)?[A-Za-z0-9_-]+/;
    const validVideos = videos.map(url => (url === '' || youtubeRegex.test(url)) ? url : '');

    try {
      await setDoc(doc(db, 'settings', 'youtubeVideos'), { urls: validVideos });
      alert('Videos saved! Valid videos will play randomly on the main page.');
    } catch (error) {
      console.error('Error saving videos:', error);
      alert('Failed to save videos. Check console for details.');
    }
  }

  async function saveDownloadLink() {
    const downloadLink = document.getElementById('downloadLink').value.trim();
    try {
      if (downloadLink === '') {
        await setDoc(doc(db, 'settings', 'downloadLink'), { url: '' });
        alert('Download link cleared.');
        return;
      }
      const urlRegex = /^(https?:\/\/)[^\s/$.?#].[^\s]*$/;
      if (urlRegex.test(downloadLink)) {
        await setDoc(doc(db, 'settings', 'downloadLink'), { url: downloadLink });
        alert('Download link saved! It will be available on the main page.');
      } else {
        alert('Please enter a valid URL (e.g., https://example.com).');
      }
    } catch (error) {
      console.error('Error saving download link:', error);
      alert('Failed to save download link. Check console for details.');
    }
  }
</script>